name: Sync AppImage

on:
  schedule:
    - cron: '0 4 * * *' # Checks daily at 4am UTC
  workflow_dispatch:

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # -------------------------------------------------------
          # CONFIGURE THESE 3 VARIABLES FOR EACH REPO
          # -------------------------------------------------------
          UPSTREAM_REPO: "HarbourMasters/Shipwright"  # Change this!
          ZIP_PATTERN: "*Linux.zip"                   # Usually keeps same
          APP_NAME: "soh.AppImage"             # Rename for Gear Lever
          # -------------------------------------------------------
        run: |
          # 1. Get Latest Tag
          UPSTREAM_TAG=$(gh release list --repo "$UPSTREAM_REPO" --limit 1 --json tagName --jq '.[0].tagName')
          echo "Latest upstream: $UPSTREAM_TAG"

          # 2. Check if we already have it
          if gh release view "$UPSTREAM_TAG" > /dev/null 2>&1; then
            echo "Version $UPSTREAM_TAG already exists. Exiting."
            exit 0
          fi

          echo "New version found! Downloading..."

          # 3. Download the Linux Zip
          gh release download "$UPSTREAM_TAG" --repo "$UPSTREAM_REPO" --pattern "$ZIP_PATTERN" --output update.zip || { echo "Download failed"; exit 1; }

          # 4. Extract
          unzip update.zip -d extracted

          # 5. Find and Rename AppImage
          # This finds ANY .appimage (case insensitive) and moves it to your desired name
          find extracted -type f -iname "*.appimage" -exec mv {} "./$APP_NAME" \; -quit

          if [ ! -f "./$APP_NAME" ]; then
            echo "Error: No AppImage found in the zip file!"
            ls -R extracted
            exit 1
          fi

          # 6. Release
          gh release create "$UPSTREAM_TAG" "./$APP_NAME" \
            --title "$APP_NAME $UPSTREAM_TAG" \
            --notes "Automated mirror of $UPSTREAM_REPO version $UPSTREAM_TAG"
