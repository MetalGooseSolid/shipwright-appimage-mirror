name: Sync AppImage

on:
  schedule:
    - cron: '12 12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM_REPO: "HarbourMasters/Shipwright"
          PATTERN: "*Linux.zip"
          
        run: |
          echo "Checking $UPSTREAM_REPO..."

          # 1. Get latest release metadata from upstream
          UPSTREAM_DATA=$(gh release list --repo "$UPSTREAM_REPO" --limit 1 --json tagName,name)
          LATEST_TAG=$(echo "$UPSTREAM_DATA" | jq -r '.[0].tagName')
          RELEASE_TITLE=$(echo "$UPSTREAM_DATA" | jq -r '.[0].name')

          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not find any releases in $UPSTREAM_REPO"
            exit 1
          fi

          echo "Latest version: $LATEST_TAG"
          echo "Release Title: $RELEASE_TITLE"

          # 2. Get the SHA256 digest of the upstream Linux zip asset
          UPSTREAM_DIGEST=$(gh release view "$LATEST_TAG" --repo "$UPSTREAM_REPO" --json assets \
            --jq '.assets[] | select(.name | test("Linux\\.zip$")) | .digest')

          if [ -z "$UPSTREAM_DIGEST" ]; then
            echo "Error: Could not find digest for Linux zip asset"
            exit 1
          fi

          echo "Upstream digest: $UPSTREAM_DIGEST"

          # 3. Check if our "latest" release already has this digest
          CURRENT_NOTES=$(gh release view "latest" --json body --jq '.body' 2>/dev/null || echo "")
          if echo "$CURRENT_NOTES" | grep -qF "$UPSTREAM_DIGEST"; then
            echo "Already up to date ($UPSTREAM_DIGEST). Exiting."
            exit 0
          fi

          echo "New update found! Downloading..."

          # 4. Download the Linux Zip
          gh release download "$LATEST_TAG" --repo "$UPSTREAM_REPO" --pattern "$PATTERN" --output update.zip || { echo "Download failed"; exit 1; }

          # 5. Extract
          unzip -q update.zip -d extracted

          # 6. Find the AppImage (preserve original name)
          APPIMAGE_PATH=$(find extracted -type f -iname "*.appimage" | head -n 1)

          if [ -z "$APPIMAGE_PATH" ]; then
            echo "Error: No .appimage file found inside the zip!"
            ls -R extracted
            exit 1
          fi

          echo "Found AppImage at: $APPIMAGE_PATH"

          # 7. Delete old "latest" release and tag if they exist
          gh release delete "latest" --yes 2>/dev/null || true
          git push --delete origin "latest" 2>/dev/null || true

          # 8. Create new "latest" release
          UPSTREAM_URL="https://github.com/$UPSTREAM_REPO/releases/tag/$LATEST_TAG"
          NOTES=$(printf 'Mirror of [%s](%s)\n\n%s' "$RELEASE_TITLE" "$UPSTREAM_URL" Linux zip "$UPSTREAM_DIGEST")

          gh release create "latest" "$APPIMAGE_PATH" \
            --title "$RELEASE_TITLE" \
            --notes "$NOTES"
